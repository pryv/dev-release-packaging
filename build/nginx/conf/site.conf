
upstream api_server {
  server core:9000;
}

upstream preview_server {
  server preview:9000;
}

# upstream static_server {
#   server core:9020;
# }

server {
  listen               443;
  server_name          *.rec.la;

  # HTTP for now - TODO
  # ssl                  on;
  # ssl_certificate      /var/pryv/secret/-bundle.crt;
  # ssl_certificate_key  /var/pryv/secret/-key.pem;
  # keepalive_timeout    70;

  client_max_body_size 20M;
  
  access_log  /app/log/nginx/api.access.log;

  # location = / {
  #   proxy_pass http://static_server;
  # 
  #   proxy_set_header  X-Real-IP  $remote_addr;
  #   proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header  Host $http_host;
  #   proxy_set_header  X-Forwarded-Proto https;
  #   proxy_redirect    off;
  # 
  #   # enable websocket support
  #   proxy_http_version  1.1;
  #   proxy_set_header    Upgrade $http_upgrade;
  #   proxy_set_header    Connection "upgrade";
  # 
  #   # TEMP HACK for letting legacy "batch" calls of the API ge through
  #   limit_except GET {
  #     proxy_pass http://api_server;
  #   }
  # }
  # 
  # location = /onboarding {
  #   proxy_pass http://static_server/onboarding;
  # 
  #   proxy_set_header  X-Real-IP  $remote_addr;
  #   proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header  Host $http_host;
  #   proxy_set_header  X-Forwarded-Proto https;
  #   proxy_redirect    off;
  # }

  # location ^~ /# {
  #   proxy_pass http://static_server;
  #   proxy_set_header  X-Real-IP  $remote_addr;
  #   proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header  Host $http_host;
  #   proxy_set_header  X-Forwarded-Proto https;
  #   proxy_redirect    off;
  # }

  location /previews/ {
    proxy_pass http://preview_server/;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  Host $http_host;
    proxy_set_header  X-Forwarded-Proto https;
    proxy_redirect    off;
  }

  location / {
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  Host $http_host;
    proxy_set_header  X-Forwarded-Proto https;
    proxy_redirect    off;

    # This enables websocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://api_server;

    # Or, if only non-file requests should be forwarded: 
    #
    # root ...;
    # if (!-f $request_filename) {
    #   proxy_pass http://api_server;
    #   break;
    # }
  }
}