#!/usr/bin/env bash

set -e

# Builds an up to date version of 'pryvio/base', image layer that sits below
# all of pryv's docker images.

# Determine the build_tag and whether we need to release.
scripts/build_name

version=$(cat build_tag)
if [ -e release_build ]; then
  echo "This is a release build, it will update 'latest' tags."
fi

function release {
  local image=$1

  if [ -e ../release_build ]; then
    # Publication to registry:
    docker push $image
  fi
}

host='eu.gcr.io'

echo ""
echo "---------------------------- BUILD IMAGE: BASE ----------------------------"
echo ""
pushd base
docker build -f Dockerfile -t $host/pryvio/base:$version .
release $host/pryvio/base:$version
popd

echo ""
echo "---------------------------- BUILD IMAGE: MONGODB -------------------------"
echo ""
pushd mongodb
docker build -f Dockerfile -t $host/pryvio/mongodb:$version .
release $host/pryvio/mongodb:$version
popd

echo ""
echo "---------------------------- BUILD IMAGE: REDIS ---------------------------"
echo ""
pushd redis
docker build -f Dockerfile -t $host/pryvio/redis:$version .
release $host/pryvio/redis:$version
popd

echo ""
echo "---------------------------- BUILD IMAGE: NGINX ---------------------------"
echo ""
pushd nginx
docker build -f Dockerfile -t $host/pryvio/nginx:$version .
release $host/pryvio/nginx:$version
popd
