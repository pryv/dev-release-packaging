#!/usr/bin/env bash

set -e

# Builds an up to date version of 'pryvio/base', image layer that sits below 
# all of pryv's docker images. 

# Determine the build_tag and whether we need to release.
scripts/build_name

version=$(cat build_tag)
if [ -e release_build ]; then
  echo "This is a release build, it will update 'latest' tags."
fi

function release {
  local image=$1
  
  if [ -e ../release_build ]; then
    # Publication to registry:
    docker push $image
  fi
}

host='eu.gcr.io'

echo "---------------------------- building base -------------------------------"
pushd base
docker build -f Dockerfile -t $host/pryvio/base:$version .
release $host/pryvio/base:$version
popd

echo "---------------------------- building mongodb ----------------------------"
pushd mongodb
docker build -f Dockerfile -t $host/pryvio/mongodb:$version .
release $host/pryvio/mongodb:$version
popd

echo "---------------------------- building redis ------------------------------"
pushd redis
docker build -f Dockerfile -t $host/pryvio/redis:$version .
release $host/pryvio/redis:$version
popd

echo "---------------------------- building nginx ------------------------------"
pushd nginx
docker build -f Dockerfile -t $host/pryvio/nginx:$version .
release $host/pryvio/nginx:$version
popd

echo "---------------------------- building ruby ------------------------------"
pushd base_ruby
docker build -f Dockerfile -t $host/pryvio/base_ruby:$version .
release $host/pryvio/base_ruby:$version
popd
