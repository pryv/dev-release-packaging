#!/usr/bin/env bash

set -e

# Builds an up to date version of 'pryvio/base', image layer that sits below 
# all of pryv's docker images. 

# Determine the build_tag and whether we need to release.
scripts/build_name

version=$(cat build_tag)
if [ -e release_build ]; then
  echo "This is a release build, it will update 'latest' tags."
fi

function release {
  local host='eu.gcr.io'
  local service_name=$1
  local version=$2
  
  local local_name="$service_name:$version"
  local remote_name="$host/$service_name:$version"
  
  if [ -e ../release_build ]; then
    # Publication to registry:
    sudo docker tag $local_name $remote_name
    sudo docker push $remote_name
  fi
}

echo "---------------------------- building base -------------------------------"
pushd base
sudo docker build -f Dockerfile -t pryvio/base:$version .
release "pryvio/base" $version
popd

echo "---------------------------- building mongodb ----------------------------"
pushd mongodb
sudo docker build -f Dockerfile -t pryvio/mongodb:$version .
release "pryvio/mongodb" $version
popd

echo "---------------------------- building redis ------------------------------"
pushd redis
sudo docker build -f Dockerfile -t pryvio/redis:$version .
release "pryvio/redis" $version
popd

echo "---------------------------- building nginx ------------------------------"
pushd nginx
sudo docker build -f Dockerfile -t pryvio/nginx:$version .
release "pryvio/nginx" $version
popd

echo "---------------------------- building ruby ------------------------------"
pushd base_ruby
sudo docker build -f Dockerfile -t pryvio/base_ruby:$version .
release "pryvio/base_ruby" $version
popd
